version: "3.8"

services:
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile.dev
        ports:
            - "${FRONTEND_PORT:-5173}:5173"
        volumes:
            - ./frontend:/app
            - /app/node_modules
            - vite_cache:/app/.vite
        environment:
            - PORT=5173
            - VITE_BACKEND_HOST=${BACKEND_HOST:-backend}
            - VITE_BACKEND_PORT=${BACKEND_PORT:-8080}
            - NODE_ENV=development
        depends_on:
            backend:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:5173"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        ports:
            - "${BACKEND_PORT:-8080}:8080"
        environment:
            - SPRING_DATASOURCE_URL=${DB_URL:-jdbc:postgresql://db:5432/monkey_d_vuvi}
            - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-admin}
            - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-admin}
            - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173}
        depends_on:
            db:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    db:
        image: postgres:15-alpine
        ports:
            - "${DB_PORT:-6001}:5432"
        environment:
            - POSTGRES_DB=${DB_NAME:-monkey_d_vuvi}
            - POSTGRES_USER=${DB_USERNAME:-admin}
            - POSTGRES_PASSWORD=${DB_PASSWORD:-admin}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-admin} -d ${DB_NAME:-monkey_d_vuvi}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

volumes:
    postgres_data:
    vite_cache:
