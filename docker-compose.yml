services:
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile.dev
        ports:
            - "${FRONTEND_PORT:-5173}:5173"
        volumes:
            - ./frontend:/app
            - /app/node_modules
        environment:
            - PORT=5173
            - VITE_BACKEND_HOST=${BACKEND_HOST:-backend}
            - VITE_BACKEND_PORT=${BACKEND_PORT:-8080}
            - SERVER_NAME=localhost
            - CORS_ALLOWED_ORIGIN=*
            - NODE_ENV=development
            # Optimize Node.js memory usage - increased for esbuild stability
            - NODE_OPTIONS=--max-old-space-size=512
            # Vite-specific optimizations
            - VITE_CJS_IGNORE_WARNING=true
            - VITE_LEGACY_BUILD=false
        depends_on:
            backend:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:5173"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        # Thêm tmpfs để cache vite transforms in memory (nhanh hơn disk)
        tmpfs:
            - /app/.vite:size=128M,mode=1777
        deploy:
            resources:
                limits:
                    memory: 1024M
                    cpus: "0.75"
                reservations:
                    memory: 512M
                    cpus: "0.5"

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        ports:
            - "${BACKEND_PORT:-8080}:8080"
        environment:
            - SPRING_DATASOURCE_URL=${DB_URL:-jdbc:postgresql://db:5432/${DB_NAME:-mosd-project}}
            - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-postgres}
            - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-postgres}
            - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173,https://monkey-d-vuvi-frontend.onrender.com}
            - CHATBOT_HOST=${CHATBOT_HOST:-chatbot}
            - CHATBOT_PORT=${CHATBOT_PORT:-8000}
        depends_on:
            db:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        deploy:
            resources:
                limits:
                    memory: 1536M
                    cpus: "1.5"
                reservations:
                    memory: 768M
                    cpus: "0.75"

    db:
        image: postgres:15-alpine
        ports:
            - "${DB_PORT:-5432}:5432"
        environment:
            - POSTGRES_DB=${DB_NAME:-mosd-project}
            - POSTGRES_USER=${DB_USERNAME:-postgres}
            - POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
            # Reduce PostgreSQL memory usage
            - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
        command: postgres -c shared_buffers=64MB -c effective_cache_size=128MB -c maintenance_work_mem=32MB -c work_mem=4MB
        volumes:
            - postgres_data:/var/lib/postgresql/data
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_NAME:-mosd-project}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        deploy:
            resources:
                limits:
                    memory: 1024M
                    cpus: "1.0"
                reservations:
                    memory: 512M
                    cpus: "0.5"

    chatbot:
        build:
            context: ./Chatbot
            dockerfile: Dockerfile
        ports:
            - "${CHATBOT_PORT:-8000}:8000"
        environment:
            - OPENAI_API_KEY=${OPENAI_API_KEY:-}
            - TAVILY_API_KEY=${TAVILY_API_KEY:-}
            - DB_USERNAME=${CHATBOT_DB_USERNAME:-${DB_USERNAME:-postgres}}
            - DB_PASSWORD=${CHATBOT_DB_PASSWORD:-${DB_PASSWORD:-postgres}}
            - DB_NAME=${CHATBOT_DB_NAME:-chatbot_db}
            - DB_HOST=${CHATBOT_DB_HOST:-db}
            - DB_PORT=${CHATBOT_DB_PORT:-5432}
            - QDRANT_HOST=${QDRANT_HOST:-qdrant}
            - QDRANT_PORT=${QDRANT_PORT:-6333}
            - QDRANT_COLLECTION=${QDRANT_COLLECTION:-hotels_and_ship_and_restaurants}
            - FRONTEND_BASE_URL=${FRONTEND_BASE_URL:-http://localhost:5173}
            - SKIP_RAG_INIT=${SKIP_RAG_INIT:-false}
        volumes:
            - ./Chatbot:/app
            - chatbot_qdrant_storage:/app/qdrant_storage
        depends_on:
            db:
                condition: service_healthy
            qdrant:
                condition: service_started
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/docs"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        deploy:
            resources:
                limits:
                    memory: 2048M
                    cpus: "2.0"
                reservations:
                    memory: 1024M
                    cpus: "1.0"

    qdrant:
        image: qdrant/qdrant:latest
        ports:
            - "${QDRANT_PORT:-6333}:6333"
            - "${QDRANT_GRPC_PORT:-6334}:6334"
        volumes:
            - chatbot_qdrant_storage:/qdrant/storage
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", 'python3 -c "import urllib.request; urllib.request.urlopen(''http://localhost:6333/readyz'').read()" || exit 1']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        deploy:
            resources:
                limits:
                    memory: 512M
                    cpus: "0.5"
                reservations:
                    memory: 256M
                    cpus: "0.25"

volumes:
    postgres_data:
    chatbot_qdrant_storage:
