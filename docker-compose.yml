version: "3.8"

services:
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile.dev
        ports:
            - "${FRONTEND_PORT:-5173}:5173"
        volumes:
            - ./frontend:/app
            - /app/node_modules
            # Persist Vite cache across restarts để giảm memory spike khi rebuild
            - vite_cache:/app/.vite
        environment:
            - PORT=5173
            - VITE_BACKEND_HOST=${BACKEND_HOST:-backend}
            - VITE_BACKEND_PORT=${BACKEND_PORT:-8080}
            - SERVER_NAME=localhost
            - CORS_ALLOWED_ORIGIN=*
            - NODE_ENV=development
            # Optimize Node.js memory usage - reduced heap size
            - NODE_OPTIONS=--max-old-space-size=384 --optimize-for-size --gc-interval=100 --max-semi-space-size=2
            # Vite-specific optimizations
            - VITE_CJS_IGNORE_WARNING=true
            - VITE_LEGACY_BUILD=false
        depends_on:
            backend:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:5173"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        # Thêm tmpfs để cache vite transforms in memory (nhanh hơn disk)
        tmpfs:
            - /app/.vite:size=128M,mode=1777
        deploy:
            resources:
                limits:
                    memory: 640M
                    cpus: '0.5'
                reservations:
                    memory: 256M
                    cpus: '0.25'

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        ports:
            - "${BACKEND_PORT:-8080}:8080"
        environment:
            - SPRING_DATASOURCE_URL=${DB_URL:-jdbc:postgresql://db:5432/monkey_d_vuvi}
            - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-admin}
            - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-admin}
            - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173,https://monkey-d-vuvi-frontend.onrender.com}
            - CHATBOT_HOST=host.docker.internal
            - CHATBOT_PORT=${CHATBOT_PORT:-8000}
        extra_hosts:
            - "host.docker.internal:host-gateway"
        depends_on:
            db:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        deploy:
            resources:
                limits:
                    memory: 1536M
                    cpus: '1.5'
                reservations:
                    memory: 768M
                    cpus: '0.75'

    db:
        image: postgres:15-alpine
        ports:
            - "${DB_PORT:-6001}:5432"
        environment:
            - POSTGRES_DB=${DB_NAME:-monkey_d_vuvi}
            - POSTGRES_USER=${DB_USERNAME:-admin}
            - POSTGRES_PASSWORD=${DB_PASSWORD:-admin}
            # Reduce PostgreSQL memory usage
            - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
        command: postgres -c shared_buffers=64MB -c effective_cache_size=128MB -c maintenance_work_mem=32MB -c work_mem=4MB
        volumes:
            - postgres_data:/var/lib/postgresql/data
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-admin} -d ${DB_NAME:-monkey_d_vuvi}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        deploy:
            resources:
                limits:
                    memory: 1024M
                    cpus: '1.0'
                reservations:
                    memory: 512M
                    cpus: '0.5'

volumes:
    postgres_data:
    vite_cache:
